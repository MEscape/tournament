generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String      @id @default(cuid())
  username      String      @unique
  password      String
  imageUrl      String
  role          Role        @default(USER)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // 1:1 mit AccessCode (nur für USER role)
  accessCodeId  String?     @unique
  accessCode    AccessCode? @relation("UserAccessCode", fields: [accessCodeId], references: [id])

  // Admin kann Codes erstellen
  createdAccessCodes AccessCode[] @relation("AdminCreatedCodes")

  // Theme Suggestions
  themeSuggestions ThemeSuggestion[]

  @@index([username])
}


model AccessCode {
  id            String    @id @default(cuid())
  code          String    @unique @default(uuid())
  revoked       Boolean   @default(false)
  isAdminCode   Boolean   @default(false)
  createdAt     DateTime  @default(now())
  revokedAt     DateTime?

  // Wer hat den Code erstellt (Admin)
  createdById   String
  createdBy     User      @relation("AdminCreatedCodes", fields: [createdById], references: [id], onDelete: Cascade)

  // Welcher User hat diesen Code verwendet (1:1)
  user          User?     @relation("UserAccessCode")

  @@index([code])
  @@index([revoked])
  @@index([isAdminCode])
}

model ThemeSuggestion {
  id            String            @id @default(cuid())
  title         String
  description   String?

  // Einkaufslisten-Context
  shop          String?           // Welcher Laden (z.B. "ALDI", "LIDL", "Rewe")
  budget        Int?              // Budget in Cent
  preferences   String?           // JSON String mit Präferenzen (z.B. "nur Batterien", "viel Feuerwerk")

  status        ThemeStatus       @default(PENDING)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  reviewedAt    DateTime?

  // User who suggested the theme
  userId        String
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Admin review
  reviewNote    String?

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Theme {
  id            String      @id @default(cuid())
  title         String      @unique
  description   String?

  // Einkaufslisten-Context
  shop          String?
  budget        Int?
  preferences   String?

  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  activeMatches ActiveMatch[]

  @@index([isActive])
  @@index([title])
}

model ActiveMatch {
  id            String         @id @default(cuid())

  // Theme
  themeId       String
  theme         Theme          @relation(fields: [themeId], references: [id])

  // Config
  duration      Int            // in seconds
  startedAt     DateTime?
  endsAt        DateTime?

  // Players
  player1Id     String
  player1Name   String
  player1Image  String
  player1List   String         @default("")

  player2Id     String
  player2Name   String
  player2Image  String
  player2List   String         @default("")

  // Result
  winnerId      String?
  status        ActiveMatchStatus @default(PENDING)

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([status])
  @@index([startedAt])
}

enum ActiveMatchStatus {
  PENDING
  RUNNING
  COMPLETED
  CANCELLED
}

enum ThemeStatus {
  PENDING
  APPROVED
  REJECTED
}

enum Role {
  USER
  ADMIN
}

